# =============================================================================
# Docker Compose for Alpamayo-R1 Experiments
# =============================================================================
# Usage:
#   docker compose build          # Build image
#   docker compose run test       # Run basic inference test
#   docker compose up notebook    # Start Jupyter notebook
#   docker compose run shell      # Interactive shell
# =============================================================================

# Shared configuration (runtime only, no build)
x-common: &common
  image: alpamayo-runner:latest

  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]

  env_file:
    - .env
  environment:
    - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}

  volumes:
    - hf-cache:/cache/huggingface
    - torch-cache:/cache/torch
    - ../experiments/workstation/inference_results:/results
    - ../experiments/classification_results:/data/classification_results

  working_dir: /app

services:
  # ---------------------------------------------------------------------------
  # Test: Run basic inference test (also defines the build)
  # ---------------------------------------------------------------------------
  test:
    <<: *common
    build:
      context: ..
      dockerfile: docker/Dockerfile
    command: test

  # ---------------------------------------------------------------------------
  # Notebook: Start Jupyter
  # ---------------------------------------------------------------------------
  notebook:
    <<: *common
    command: notebook
    ports:
      - "${JUPYTER_PORT:-8888}:8888"

  # ---------------------------------------------------------------------------
  # Shell: Interactive bash
  # ---------------------------------------------------------------------------
  shell:
    <<: *common
    stdin_open: true
    tty: true
    command: bash

  # ---------------------------------------------------------------------------
  # Classify: Batch scene classification (requires external Ollama)
  # ---------------------------------------------------------------------------
  classify:
    <<: *common
    command: classify
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  hf-cache:
    name: alpamayo-hf-cache
  torch-cache:
    name: alpamayo-torch-cache
