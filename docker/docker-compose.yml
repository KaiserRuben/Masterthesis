# =============================================================================
# Docker Compose for Alpamayo-R1 Experiments
# =============================================================================
# Usage:
#   docker compose build          # Build image first
#   docker compose run test       # Run basic inference test
#   docker compose up notebook    # Start Jupyter notebook
#   docker compose run shell      # Interactive shell
# =============================================================================

# Shared configuration (no build - image must be pre-built)
x-common: &common
  image: alpamayo-runner:latest

  # GPU access
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]

  # Environment
  env_file:
    - .env
  environment:
    - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}

  # Volumes
  volumes:
    # Cache (persist model weights between runs)
    - hf-cache:/cache/huggingface
    - torch-cache:/cache/torch

    # Results (persist experiment outputs)
    - ../experiments/workstation/inference_results:/results
    - ../experiments/classification_results:/data/classification_results

  # Working directory
  working_dir: /app

services:
  # ---------------------------------------------------------------------------
  # Builder: Only this service builds the image
  # ---------------------------------------------------------------------------
  builder:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: alpamayo-runner:latest
    profiles: ["build"]
    command: echo "Build complete"

  # ---------------------------------------------------------------------------
  # Test: Run basic inference test
  # ---------------------------------------------------------------------------
  test:
    <<: *common
    command: test

  # ---------------------------------------------------------------------------
  # Notebook: Start Jupyter
  # ---------------------------------------------------------------------------
  notebook:
    <<: *common
    command: notebook
    ports:
      - "${JUPYTER_PORT:-8888}:8888"

  # ---------------------------------------------------------------------------
  # Shell: Interactive bash
  # ---------------------------------------------------------------------------
  shell:
    <<: *common
    stdin_open: true
    tty: true
    command: bash

  # ---------------------------------------------------------------------------
  # Classify: Run batch scene classification (requires external Ollama)
  # ---------------------------------------------------------------------------
  classify:
    <<: *common
    command: classify
    extra_hosts:
      - "host.docker.internal:host-gateway"

# -----------------------------------------------------------------------------
# Persistent volumes
# -----------------------------------------------------------------------------
volumes:
  hf-cache:
    name: alpamayo-hf-cache
  torch-cache:
    name: alpamayo-torch-cache
